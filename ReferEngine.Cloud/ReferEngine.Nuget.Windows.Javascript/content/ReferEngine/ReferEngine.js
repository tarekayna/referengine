define("../common/Messaging",["require","exports"],function(e,t){var n=function(){function e(e,t){this.details=t,this.functionInfo=e}return e.prototype.getString=function(){var e={functionInfo:this.functionInfo};return this.details&&(e.details=this.details),JSON.stringify(e)},e.parse=function(n){var r=JSON.parse(n);return new e(r.functionInfo,r.details)},e}();t.Message=n,function(e){e._map=[],e._map[0]="IFrameToClient",e.IFrameToClient=0,e._map[1]="ClientToIframe",e.ClientToIframe=1}(t.MessengerType||(t.MessengerType={}));var r=t.MessengerType,i=function(){function e(e,t){this.type=e,this.receiveOrigin=t,this.messageHandlers=[];var n=this;window.addEventListener("message",function(e){n.receive(e)})}return e.prototype.send=function(e){this.type==r.IFrameToClient?window.parent.postMessage(e.getString(),this.parentLocation):this.iframe.contentWindow.postMessage(e.getString(),this.iframe.src)},e.prototype.call=function(e,t){var r=new n(e,t);this.send(r)},e.prototype.receive=function(e){if(e.origin===this.receiveOrigin){var t=n.parse(e.data);for(var r=0;r<this.messageHandlers.length;r++)this.messageHandlers[r].msg===t.functionInfo.name&&this.messageHandlers[r].handler(t.details)}},e.prototype.addMessageHandler=function(e,t){this.messageHandlers.push({msg:e,handler:t})},e}();t.Messenger=i;var s=function(){function e(e,t){this.success=e,this.code=t}return e}();t.AuthResult=s}),define("../common/Functions",["require","exports"],function(e,t){var n=function(){function e(e,t){this.info=e,this.handler=t}return e}();t.Function=n;var r=function(){function e(e){this.messenger=e,this.functions=[]}return e.prototype.add=function(e){this.functions.push(e),this.messenger.addMessageHandler(e.info.name,e.handler)},e.prototype.addRange=function(e){for(var t=0;t<e.length;t++)this.add(e[t])},e}();t.FunctionRange=r;var i=function(){function e(e){this.name=e}return e}();t.FunctionInfo=i;var s=function(){function e(){}return e.authFacebook=new i("authFacebook"),e.hide=new i("hide"),e.hideLoading=new i("hideLoading"),e.navigate=new i("navigate"),e.setAutoAsk=new i("setAutoAsk "),e.setIntroPageLoaded=new i("setIntroPageLoaded"),e.setLoadingText=new i("setLoadingText"),e.showLoading=new i("showLoading"),e}();t.ClientFunction=s;var o=function(){function e(){}return e.closedWhileLoading=new i("closedWhileLoading"),e.introVisible=new i("introVisible"),e.authFacebookResult=new i("authFacebookResult"),e}();t.ServerFunction=o}),define("WindowsClientScript",["require","exports","../common/Messaging","../common/Functions"],function(e,t,n,r){var i=n,s=r;(function(e){function y(){if(!l){var t=x.createElement("style");t.innerText=b.style,t.type="text/css";var n=document.getElementsByTagName("link")[0];n.parentNode.insertBefore(t,n);var r=document.querySelector("body");x.container=x.createDiv("re-container"),r.appendChild(x.container),x.iframe=x.createElement("iframe"),x.container.appendChild(x.iframe),x.loading=x.createDiv("re-loading-container"),x.container.appendChild(x.loading);var i=x.createDiv("re-close");i.innerText="îˆœ",x.loading.appendChild(i),i.addEventListener("click",function(){d.call(g.closedWhileLoading),e.hide()});var s=x.createDiv("meter");x.progressSpan=x.createElement("span"),s.appendChild(x.progressSpan);var o=x.createDiv(null);x.loading.appendChild(o);var u=x.createImg(b.logoMarkImageData,"re-logo-mark"),a=x.createImg(b.logoTextImageData,"re-logo-text");x.loadingTextElem=x.createDiv("re-loading-text"),o.appendChild(u),o.appendChild(a),o.appendChild(s),o.appendChild(x.loadingTextElem),l=!0,d.iframe=x.iframe}}function C(){var e=Windows.Networking.Connectivity.NetworkInformation.getInternetConnectionProfile();if(!e){var t="ReferEngine requires a working internet connection.",n="Not Connected to the Internet",r=new Windows.UI.Popups.MessageDialog(t,n);return r.showAsync(),!1}return!0}function k(e){C()&&(T.loadIntro(e),p.fadeIn(x.container).then(function(){x.unHideElement(x.container)}))}function L(){p.fadeOut(x.container).then(function(){x.hideElement(x.container)})}function A(e){return e.indexOf("?")==-1?N.authorizeAppAsync().done(function(t){x.iframe.src=e+"?authToken="+t}):N.authorizeAppAsync().done(function(t){x.iframe.src=e+"&authToken="+t})}function M(){return N.authorizeAppAsync().done(function(n){if(n){if(t.onLoadArray)for(var r=0;r<t.onLoadArray.length;r++)t.onLoadArray[r]();E.autoOpenIfNeeded(),e.isAvailable=!0}})}var t=ReferEngineClient,n=Windows.Storage.ApplicationData.current,r=n.roamingSettings,o=n.localSettings,u=!1,a=Windows.ApplicationModel.Store,f,l=!1,c=t.appActivationArgs,h=WinJS.Utilities,p=WinJS.UI.Animation,d,v,m=s.ClientFunction,g=s.ServerFunction;e.isAvailable=!1;if(!t.appId)throw"ReferEngineClient.appId must be defined.";t.appIsPublished?f=a.CurrentApp:f=a.CurrentAppSimulator;var b=function(){function e(){}return e._styleKey="ReferEngine-Style",Object.defineProperty(e,"style",{get:function(){return o.values[e._styleKey]},set:function(t){o.values[e._styleKey]=t},enumerable:!0,configurable:!0}),e._loadingMessagesKey="ReferEngine-LoadingMessages",Object.defineProperty(e,"loadingMessages",{get:function(){if(e._loadingMessagesCached)return e._loadingMessagesCached;var t=o.values[e._loadingMessagesKey];return e._loadingMessagesCached=JSON.parse(t).value,e._loadingMessagesCached},set:function(t){e._loadingMessagesCached=t;var n=JSON.stringify({value:t});o.values[e._loadingMessagesKey]=n},enumerable:!0,configurable:!0}),e._logoMarkImageDataKey="ReferEngine-LogoMarkImageData",Object.defineProperty(e,"logoMarkImageData",{get:function(){return o.values[e._logoMarkImageDataKey]},set:function(t){o.values[e._logoMarkImageDataKey]=t},enumerable:!0,configurable:!0}),e._logoTextImageDataKey="ReferEngine-LogoTextImageData",Object.defineProperty(e,"logoTextImageData",{get:function(){return o.values[e._logoTextImageDataKey]},set:function(t){o.values[e._logoTextImageDataKey]=t},enumerable:!0,configurable:!0}),e._fbScopeKey="ReferEngine-FacebookScope",Object.defineProperty(e,"fbScope",{get:function(){return o.values[e._fbScopeKey]},set:function(t){o.values[e._fbScopeKey]=t},enumerable:!0,configurable:!0}),e}(),w=function(){function e(){}return e._timeoutDefault=15e3,e._timeoutKey="ReferEngine-AutoShowTimeout",Object.defineProperty(e,"timeout",{get:function(){var t=r.values[e._timeoutKey];return t?t:(r.values[e._timeoutKey]=e._timeoutDefault,e._timeoutDefault)},set:function(t){r.values[e._timeoutKey]=t},enumerable:!0,configurable:!0}),e._intervalDefault=2,e._intervalKey="ReferEngine-AutoShowInterval",Object.defineProperty(e,"interval",{get:function(){var t=r.values[e._intervalKey];return t?t:(r.values[e._intervalKey]=e._intervalDefault,e._intervalDefault)},set:function(t){r.values[e._intervalKey]=t},enumerable:!0,configurable:!0}),e._enableDefault=!0,e._enableKey="ReferEngine-AutoShowEnable",Object.defineProperty(e,"enable",{get:function(){var t=r.values[e._enableKey];return t?t:(r.values[e._enableKey]=e._enableDefault,e._enableDefault)},set:function(t){r.values[e._enableKey]=t},enumerable:!0,configurable:!0}),e}(),E=function(){function t(){}return t._launchCountKey="ReferEngine-LaunchCount",Object.defineProperty(t,"launchCount",{get:function(){var e=r.values[t._launchCountKey];return e?e:(r.values[t._launchCountKey]=0,0)},set:function(e){r.values[t._launchCountKey]=e},enumerable:!0,configurable:!0}),t._autoAskAgainKey="ReferEngine-AutoAskAgain",Object.defineProperty(t,"autoAskAgain",{get:function(){var e=r.values[t._autoAskAgainKey];return e?e:(r.values[t._autoAskAgainKey]=w.enable,w.enable)},set:function(e){r.values[t._autoAskAgainKey]=e},enumerable:!0,configurable:!0}),t.shouldAutoOpen=function(){return t.launchCount%w.interval===0&&t.autoAskAgain},t.autoOpenIfNeeded=function(){if(c){var r=c.detail.previousExecutionState,i=Windows.ApplicationModel.Activation.ApplicationExecutionState;r!==i.running&&r!==i.suspended&&t.launchCount++,t.shouldAutoOpen()&&setTimeout(function(){window.msRequestAnimationFrame(function(){e.show(!0)})},w.timeout)}},t}(),S=function(){function e(){}return e.base="http://127.0.0.1:81",e.introBase=e.base+"/recommend/win8/intro/"+t.appId,e.auth=e.base+"/recommend/win8/authorizeapp",e.getIntroUrl=function(n){return e.introBase+"?isAutoOpen="+(n?"true":"false")},e}(),x=function(){function e(){}return e.createElement=function(t){return document.createElement(t)},e.createDiv=function(n){var r=e.createElement("div");return n!==null&&n!==undefined&&(r.className=n),r},e.createImg=function(n,r){var i=e.createElement("img");return i.src=n,i.className=r,i},e.hideElement=function(t){h.addClass(t,"re-hidden")},e.unHideElement=function(t){h.removeClass(t,"re-hidden")},e}(),T=function(){function e(){}return e.hideRing=function(){x.progressSpan.style.visibility="hidden"},e.showRing=function(){x.progressSpan.style.visibility="visible"},e.show=function(){p.enterContent(x.loading).then(function(){x.unHideElement(x.loading)})},e.hide=function(){p.fadeOut(x.loading).then(function(){x.hideElement(x.loading)})},e.setText=function(n){n.substr(0,5)==="Error"&&e.hideRing(),p.exitContent(x.loadingTextElem).done(function(){x.loadingTextElem.innerText=n,p.enterContent(x.loadingTextElem)})},e.loadIntro=function(n){y(),A(S.getIntroUrl(n)),e.showRing();var r=0,i=document.createEvent("CustomEvent");i.initCustomEvent("showNextLoadingMessage",!0,!0,null),document.addEventListener("showNextLoadingMessage",function(){e.setText(b.loadingMessages[r]),r=r===b.loadingMessages.length-1?0:r+1,u||setTimeout(function(){document.dispatchEvent(i)},3e3)}),document.dispatchEvent(i)},e}(),N=function(){function e(){}return e._token="ReferEngine-AuthToken",e._expires="ReferEngine-TokenExpiresAt",e.getStoredToken=function(){function n(){return o.values[e._expires]=null,o.values[e._token]=null,null}var r=o.values[e._expires],i=o.values[e._token];if(!r||!i)return n();var s=new Date,u=s.getTime(),a=600;return r-a<u?n():i},e.setStoredToken=function(n,r){var i=new Date;i.setSeconds(i.getSeconds()+r),o.values[e._token]=n,o.values[e._expires]=i},e.authorizeFacebookAsync=function(){return new WinJS.Promise(function(e,t,n){var r="https://www.referengine.com/recommend/win8/success",s="client_id=368842109866922&redirect_uri="+r+"&scope="+b.fbScope+"&display=popup&response_type=code",o="https://www.facebook.com/dialog/oauth?"+s,u=new Windows.Foundation.Uri(o),a=new Windows.Foundation.Uri(r),f=Windows.Security.Authentication.Web;f.WebAuthenticationBroker.authenticateAsync(f.WebAuthenticationOptions.none,u,a).done(function(t){(t.responseData.indexOf("error_reason=")!==-1||t.responseErrorDetail===404)&&e(new i.AuthResult(!1));var n="code=",r=t.responseData.indexOf(n)+n.length,s=t.responseData.substr(r);s?e(new i.AuthResult(!0,s)):e(new i.AuthResult(!1))},function(){e(new i.AuthResult(!1))})})},e.authorizeAppAsync=function(){return new WinJS.Promise(function(t,n,r){var i=e.getStoredToken();i?t(i):f.getAppReceiptAsync().done(function(n){var r=window.btoa(n);WinJS.xhr({type:"POST",headers:{"Content-type":"text/xml"},url:S.auth,data:n}).done(function(n){var r=JSON.parse(n.responseText);r.token&&r.expiresIn?(e.setStoredToken(r.token,r.expiresIn),w.enable=r.asoEnabled,w.interval=r.asoInterval,w.timeout=r.asoTimeout,b.style=r.style,b.loadingMessages=r.loadingMessages,b.logoMarkImageData=r.logoMarkImageData,b.logoTextImageData=r.logoTextImageData,b.fbScope=r.fbScope,t(r.token)):t(null)},function(){t(null)})})})},e}();e.show=k,e.hide=L;var O=[new s.Function(m.navigate,function(e){A(e.url)}),new s.Function(m.showLoading,function(e){T.show()}),new s.Function(m.hideLoading,function(e){T.hide()}),new s.Function(m.setLoadingText,function(e){T.setText(e.text)}),new s.Function(m.setAutoAsk,function(e){E.autoAskAgain=e.askAgain}),new s.Function(m.hide,function(t){e.hide()}),new s.Function(m.authFacebook,function(e){N.authorizeFacebookAsync().then(function(e){d.call(g.authFacebookResult,{authResult:e})})}),new s.Function(m.setIntroPageLoaded,function(e){u=!0,d.call(g.introVisible)})];d=new i.Messenger(i.MessengerType.ClientToIframe,S.base),v=new s.FunctionRange(d),v.addRange(O),window.ReferEngine=e,M()})(t.ReferEngine||(t.ReferEngine={}));var o=t.ReferEngine});