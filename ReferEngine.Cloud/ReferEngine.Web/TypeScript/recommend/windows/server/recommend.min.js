define(["require","exports","common","../common/Functions"],function(n,t,i,r){var u=i,f=r;n(["../../../lib/knockout"],function(n){$(document).ready(function(){var h=u.MixPanel,b=$("#submit-button"),k=$("#cancel-button"),d=$("#done-button"),t=$("#message"),c=$("#asContainer"),g=$(".post"),y=$(".postResult"),nt=$("#agree"),l=$("#re-content .text-message"),o=0,a=0,v="",i=u.messenger,r=f.ClientFunction,e="",s,p,w;y.hide(),l.hide(),d.click(function(){i.call(r.setAutoAsk,{askAgain:!1}),i.call(r.hide)}),s={enter:13,space:32,up:38,down:40},t.focusin(function(){$(".msg-placeholder").css("display","none")}),p=function(){},w=function(i){var y=function(){var t=this;t.msgText=n.observable(""),t.msgHTML=n.observable(""),t.searchString=n.observable(""),t.friends=JSON.parse(i.friends),t.selectedIndex=n.observable(-1),t.searchResult=n.computed(function(){var n=t.searchString().toLowerCase(),u=[],f=[],i;if(n!==undefined&&n!=="")for(i=0;i<t.friends.length;i++){var r=t.friends[i],e=r.FirstName.toLowerCase(),o=r.LastName.toLowerCase();e.indexOf(n)===0&&u.push(r),o.indexOf(n)===0&&f.push(r)}return u.concat(f)}),t.onClick=function(n){h(n)}},r=new y;n.applyBindings(r),r.searchResult.subscribe(function(n){var i,r;n.length>0?(i=t.find(".search-str"),i.length>0&&(r=i.offset(),r.top+=i.outerHeight(),c.offset(r),i.addClass("highlighted"))):c.css("display","none")});var f=function(){var n=t.find(".search-str");n.length>0&&n.replaceWith(n.text())},h=function(n){t.find(".search-str").replaceWith("<span class='friendTag' data-friend-id='"+n.FacebookId+"'>"+n.Name+"<\/span>"),t.focus(),r.searchString("")},l,u=function(n){return l===n.timeStamp},p=function(){r.searchResult()!==[]&&r.selectedIndex(r.selectedIndex()+1)},w=function(){r.searchResult()!==[]&&r.selectedIndex(r.selectedIndex()-1)};t.focusout(function(){setTimeout(function(){f(),r.searchString("")},500)}),t.keydown(function(n){if(n.which===s.enter){var i=r.selectedIndex();r.searchResult()!==[]&&i!==-1&&(h(r.searchResult()[i]),t.find("p").last().remove()),n.stopImmediatePropagation(),n.preventDefault()}}),t.keyup(function(n){var k,d,i,h;if(n.which===s.up)return w();if(n.which===s.down)return p();if(r.selectedIndex(-1),l=n.timeStamp,f(),r.msgText(t.text()),e="",k=r.msgText(),d=k.length,d===v.length+1)for(i=d-1;i>=0&&u(n);i--)if(k.charAt(i)!==v.charAt(i-1)){if(a=i,e=k.substring(0,i+1),o=e.lastIndexOf(" ")+1,e=e.substring(o),e!==""){var c=t.html(),g=o,nt=a,y=-1,b=!0;if(c.indexOf("<")!==-1)for(h=0;h<c.length;h++)if(b=c.charAt(h)==="<"?!1:b,y=b?y+1:y,b=c.charAt(h)===">"?!0:b,y===o&&(g=h),y===a){nt=h;break}var tt=c.substring(0,g),it=c.substring(nt+1),rt=tt+"<span class='search-str'>"+e+"<\/span>"+it;u(n)&&r.msgHTML(rt)}break}u(n)&&(r.searchString(e),v=r.msgText(),r.msgHTML(t.html()))})},$.ajax(u.Url.getFriends,{type:"POST",data:{authToken:re.referEngineAuthToken},dataType:"json",error:p,success:w});var tt=function(){i.call(r.setLoadingText,{text:"Error posting to Facebook. Please try again."}),i.call(r.showLoading)},it=function(){g.hide(),y.show(),i.call(r.hideLoading)},rt=function(){l.show({complete:function(){setTimeout(function(){l.hide({duration:1e3})},2e3)}})};b.click(function(){var f,n,e;nt[0].checked?(i.call(r.setLoadingText,{text:"Posting to Facebook..."}),i.call(r.showLoading),f=t.clone(),n=f.find(".friendTag"),n.length>0&&n.replaceWith(function(){var n=$(this).attr("data-friend-id");$(this).replaceWith("@["+n+"]")}),e=f.text(),$.ajax({type:"POST",url:u.Url.postRecommendation,data:{message:e,authToken:re.referEngineAuthToken},dataType:"json",error:tt,success:it}),h.track("Action",{Action:"Recommend Post Submit","Includes Message":e!=="","Includes Tags":n.length>0})):rt()}),k.click(function(){i.call(r.hide),h.track("Action",{Action:"Recommend Post Cancel"})}),c.css("display","none"),i.call(r.hideLoading),h.track("Page View",{Page:"Recommend Post"})})})})