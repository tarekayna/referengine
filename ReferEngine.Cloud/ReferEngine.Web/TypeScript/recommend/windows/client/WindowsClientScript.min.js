define(["require","exports","../common/Messaging","../common/Functions"],function(n,t,i,r){var f=i,u=r,e;(function(n){function et(){var r,f,s,u,o,i,h,c;g||(r=t.createElement("style"),r.innerText=e.style,r.type="text/css",f=document.getElementsByTagName("link")[0],f.parentNode.insertBefore(r,f),s=document.querySelector("body"),t.container=t.createDiv("re-container"),s.appendChild(t.container),t.iframe=t.createElement("iframe"),t.container.appendChild(t.iframe),t.loading=t.createDiv("re-loading-container"),t.container.appendChild(t.loading),u=t.createDiv("re-close"),u.innerText="",t.loading.appendChild(u),u.addEventListener("click",function(){l.call(y.closedWhileLoading),n.hide()}),o=t.createDiv("meter"),t.progressSpan=t.createElement("span"),o.appendChild(t.progressSpan),i=t.createDiv(null),t.loading.appendChild(i),h=t.createImg(e.logoMarkImageData,"re-logo-mark"),c=t.createImg(e.logoTextImageData,"re-logo-text"),t.loadingTextElem=t.createDiv("re-loading-text"),i.appendChild(h),i.appendChild(c),i.appendChild(o),i.appendChild(t.loadingTextElem),g=!0,l.iframe=t.iframe)}function ot(){var n=Windows.Networking.Connectivity.NetworkInformation.getInternetConnectionProfile();if(!n){var t=new Windows.UI.Popups.MessageDialog("ReferEngine requires a working internet connection.","Not Connected to the Internet");return t.showAsync(),!1}return!0}function st(n){ot()&&(a.loadIntro(n),c.fadeIn(t.container).then(function(){t.unHideElement(t.container)}))}function ht(){c.fadeOut(t.container).then(function(){t.hideElement(t.container)})}function ut(n){return n.indexOf("?")==-1?v.authorizeAppAsync().done(function(i){t.iframe.src=n+"?authToken="+i}):v.authorizeAppAsync().done(function(i){t.iframe.src=n+"&authToken="+i})}function ct(){return v.authorizeAppAsync().done(function(t){if(t){if(s.onLoadArray)for(var i=0;i<s.onLoadArray.length;i++)s.onLoadArray[i]();rt.autoOpenIfNeeded(),n.isAvailable=!0}})}var s=ReferEngineClient,w=Windows.Storage.ApplicationData.current,r=w.roamingSettings,i=w.localSettings,b=!1,k=Windows.ApplicationModel.Store,d,g=!1,nt=s.appActivationArgs,tt=WinJS.Utilities,c=WinJS.UI.Animation,l,it,o=u.ClientFunction,y=u.ServerFunction,ft;if(n.isAvailable=!1,!s.appId)throw"ReferEngineClient.appId must be defined.";d=s.appIsPublished?k.CurrentApp:k.CurrentAppSimulator;var e=function(){function n(){}return n._styleKey="ReferEngine-Style",Object.defineProperty(n,"style",{get:function(){return i.values[n._styleKey]},set:function(t){i.values[n._styleKey]=t},enumerable:!0,configurable:!0}),n._loadingMessagesKey="ReferEngine-LoadingMessages",Object.defineProperty(n,"loadingMessages",{get:function(){if(n._loadingMessagesCached)return n._loadingMessagesCached;var t=i.values[n._loadingMessagesKey];return n._loadingMessagesCached=JSON.parse(t).value,n._loadingMessagesCached},set:function(t){n._loadingMessagesCached=t;var r=JSON.stringify({value:t});i.values[n._loadingMessagesKey]=r},enumerable:!0,configurable:!0}),n._logoMarkImageDataKey="ReferEngine-LogoMarkImageData",Object.defineProperty(n,"logoMarkImageData",{get:function(){return i.values[n._logoMarkImageDataKey]},set:function(t){i.values[n._logoMarkImageDataKey]=t},enumerable:!0,configurable:!0}),n._logoTextImageDataKey="ReferEngine-LogoTextImageData",Object.defineProperty(n,"logoTextImageData",{get:function(){return i.values[n._logoTextImageDataKey]},set:function(t){i.values[n._logoTextImageDataKey]=t},enumerable:!0,configurable:!0}),n._fbScopeKey="ReferEngine-FacebookScope",Object.defineProperty(n,"fbScope",{get:function(){return i.values[n._fbScopeKey]},set:function(t){i.values[n._fbScopeKey]=t},enumerable:!0,configurable:!0}),n}(),h=function(){function n(){}return n._timeoutDefault=15e3,n._timeoutKey="ReferEngine-AutoShowTimeout",Object.defineProperty(n,"timeout",{get:function(){var t=r.values[n._timeoutKey];return t?t:(r.values[n._timeoutKey]=n._timeoutDefault,n._timeoutDefault)},set:function(t){r.values[n._timeoutKey]=t},enumerable:!0,configurable:!0}),n._intervalDefault=2,n._intervalKey="ReferEngine-AutoShowInterval",Object.defineProperty(n,"interval",{get:function(){var t=r.values[n._intervalKey];return t?t:(r.values[n._intervalKey]=n._intervalDefault,n._intervalDefault)},set:function(t){r.values[n._intervalKey]=t},enumerable:!0,configurable:!0}),n._enableDefault=!0,n._enableKey="ReferEngine-AutoShowEnable",Object.defineProperty(n,"enable",{get:function(){var t=r.values[n._enableKey];return t?t:(r.values[n._enableKey]=n._enableDefault,n._enableDefault)},set:function(t){r.values[n._enableKey]=t},enumerable:!0,configurable:!0}),n}(),rt=function(){function t(){}return t._launchCountKey="ReferEngine-LaunchCount",Object.defineProperty(t,"launchCount",{get:function(){var n=r.values[t._launchCountKey];return n?n:(r.values[t._launchCountKey]=0,0)},set:function(n){r.values[t._launchCountKey]=n},enumerable:!0,configurable:!0}),t._autoAskAgainKey="ReferEngine-AutoAskAgain",Object.defineProperty(t,"autoAskAgain",{get:function(){var n=r.values[t._autoAskAgainKey];return n?n:(r.values[t._autoAskAgainKey]=h.enable,h.enable)},set:function(n){r.values[t._autoAskAgainKey]=n},enumerable:!0,configurable:!0}),t.shouldAutoOpen=function(){return t.launchCount%h.interval==0&&t.autoAskAgain},t.autoOpenIfNeeded=function(){if(nt){var i=nt.detail.previousExecutionState,r=Windows.ApplicationModel.Activation.ApplicationExecutionState;i!==r.running&&i!==r.suspended&&t.launchCount++,t.shouldAutoOpen()&&setTimeout(function(){window.msRequestAnimationFrame(function(){n.show(!0)})},h.timeout)}},t}(),p=function(){function n(){}return n.base="http://127.0.0.1:81",n.introBase=n.base+"/recommend/win8/intro/"+s.appId,n.auth=n.base+"/recommend/win8/authorizeapp",n.getIntroUrl=function(t){return n.introBase+"?isAutoOpen="+(t?"true":"false")},n}(),t=function(){function n(){}return n.createElement=function(n){return document.createElement(n)},n.createDiv=function(t){var i=n.createElement("div");return t!==null&&t!==undefined&&(i.className=t),i},n.createImg=function(t,i){var r=n.createElement("img");return r.src=t,r.className=i,r},n.hideElement=function(n){tt.addClass(n,"re-hidden")},n.unHideElement=function(n){tt.removeClass(n,"re-hidden")},n}(),a=function(){function n(){}return n.hideRing=function(){t.progressSpan.style.visibility="hidden"},n.showRing=function(){t.progressSpan.style.visibility="visible"},n.show=function(){c.enterContent(t.loading).then(function(){t.unHideElement(t.loading)})},n.hide=function(){c.fadeOut(t.loading).then(function(){t.hideElement(t.loading)})},n.setText=function(i){i.substr(0,5)==="Error"&&n.hideRing(),c.exitContent(t.loadingTextElem).done(function(){t.loadingTextElem.innerText=i,c.enterContent(t.loadingTextElem)})},n.loadIntro=function(t){et(),ut(p.getIntroUrl(t)),n.showRing();var i=0,r=document.createEvent("CustomEvent");r.initCustomEvent("showNextLoadingMessage",!0,!0,null),document.addEventListener("showNextLoadingMessage",function(){n.setText(e.loadingMessages[i]),i=i===e.loadingMessages.length-1?0:i+1,b||setTimeout(function(){document.dispatchEvent(r)},3e3)}),document.dispatchEvent(r)},n}(),v=function(){function n(){}return n._token="ReferEngine-AuthToken",n._expires="ReferEngine-TokenExpiresAt",n.getStoredToken=function(){function t(){return i.values[n._expires]=null,i.values[n._token]=null,null}var r=i.values[n._expires],u=i.values[n._token];if(!r||!u)return t();var f=new Date,e=f.getTime();return r-600<e?t():u},n.setStoredToken=function(t,r){var u=new Date;u.setSeconds(u.getSeconds()+r),i.values[n._token]=t,i.values[n._expires]=u},n.authorizeFacebookAsync=function(){return new WinJS.Promise(function(n){var t="https://www.referengine.com/recommend/win8/success",r="client_id=368842109866922&redirect_uri="+t+"&scope="+e.fbScope+"&display=popup&response_type=code",u="https://www.facebook.com/dialog/oauth?"+r,o=new Windows.Foundation.Uri(u),s=new Windows.Foundation.Uri(t),i=Windows.Security.Authentication.Web;i.WebAuthenticationBroker.authenticateAsync(i.WebAuthenticationOptions.none,o,s).done(function(t){(t.responseData.indexOf("error_reason=")!==-1||t.responseErrorDetail===404)&&n(new f.AuthResult(!1));var i="code=",u=t.responseData.indexOf(i)+i.length,r=t.responseData.substr(u);r?n(new f.AuthResult(!0,r)):n(new f.AuthResult(!1))},function(){n(new f.AuthResult(!1))})})},n.authorizeAppAsync=function(){return new WinJS.Promise(function(t){var i=n.getStoredToken();i?t(i):d.getAppReceiptAsync().done(function(i){var r=window.btoa(i);WinJS.xhr({type:"POST",headers:{"Content-type":"text/xml"},url:p.auth,data:i}).done(function(i){var r=JSON.parse(i.responseText);r.token&&r.expiresIn?(n.setStoredToken(r.token,r.expiresIn),h.enable=r.asoEnabled,h.interval=r.asoInterval,h.timeout=r.asoTimeout,e.style=r.style,e.loadingMessages=r.loadingMessages,e.logoMarkImageData=r.logoMarkImageData,e.logoTextImageData=r.logoTextImageData,e.fbScope=r.fbScope,t(r.token)):t(null)},function(){t(null)})})})},n}();n.show=st,n.hide=ht,ft=[new u.Function(o.navigate,function(n){ut(n.url)}),new u.Function(o.showLoading,function(){a.show()}),new u.Function(o.hideLoading,function(){a.hide()}),new u.Function(o.setLoadingText,function(n){a.setText(n.text)}),new u.Function(o.setAutoAsk,function(n){rt.autoAskAgain=n.askAgain}),new u.Function(o.hide,function(){n.hide()}),new u.Function(o.authFacebook,function(){v.authorizeFacebookAsync().then(function(n){l.call(y.authFacebookResult,{authResult:n})})}),new u.Function(o.setIntroPageLoaded,function(){b=!0,l.call(y.introVisible)})],l=new f.Messenger(f.MessengerType.ClientToIframe,p.base),it=new u.FunctionRange(l),it.addRange(ft),window.ReferEngine=n,ct()})(t.ReferEngine||(t.ReferEngine={})),e=t.ReferEngine})