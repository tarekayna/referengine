define(["require","exports","../common/Messaging","../common/Functions"],function(n,t,i,r){var f=i,u=r,e;(function(n){function et(){var u,e,s,f,o,r,h,l;g||(u=t.createElement("style"),u.innerText=i.style,u.type="text/css",e=document.getElementsByTagName("link")[0],e.parentNode.insertBefore(u,e),s=document.querySelector("body"),t.container=t.createDiv("re-container"),s.appendChild(t.container),t.iframe=t.createElement("iframe"),t.container.appendChild(t.iframe),t.loading=t.createDiv("re-loading-container"),t.container.appendChild(t.loading),f=t.createDiv("re-close"),f.innerText="",t.loading.appendChild(f),f.addEventListener("click",function(){c.call(w.closedWhileLoading),n.hide()}),o=t.createDiv("meter"),t.progressSpan=t.createElement("span"),o.appendChild(t.progressSpan),r=t.createDiv(null),t.loading.appendChild(r),h=t.createImg(i.logoMarkImageData,"re-logo-mark"),l=t.createImg(i.logoTextImageData,"re-logo-text"),t.loadingTextElem=t.createDiv("re-loading-text"),r.appendChild(h),r.appendChild(l),r.appendChild(o),r.appendChild(t.loadingTextElem),g=!0,c.iframe=t.iframe)}function ot(){var n=Windows.Networking.Connectivity.NetworkInformation.getInternetConnectionProfile();if(!n){var t=new Windows.UI.Popups.MessageDialog("ReferEngine requires a working internet connection.","Not Connected to the Internet");return t.showAsync(),!1}return!0}function st(n){ot()&&p&&(y.loadIntro(n),h.fadeIn(t.container).then(function(){t.unHideElement(t.container)}),p=!1)}function ht(){h.fadeOut(t.container).then(function(){t.hideElement(t.container)}),p=!0}function ct(){a.setStoredToken(null,0),i.fbScope=null,i.loadingMessages=[],i.logoMarkImageData=null,i.logoTextImageData=null,i.style=null,o.enable=null,o.interval=null,o.timeout=null,v.autoAskAgain=!0,v.launchCount=0,i.appId=null}function rt(n){return n.indexOf("?")==-1?a.authorizeAppAsync().done(function(i){t.iframe.src=n+"?authToken="+i}):a.authorizeAppAsync().done(function(i){t.iframe.src=n+"&authToken="+i})}function lt(){return a.authorizeAppAsync().done(function(t){if(t){if(l.onLoadArray)for(var i=0;i<l.onLoadArray.length;i++)l.onLoadArray[i]();v.autoOpenIfNeeded(),n.isAvailable=!0}})}var l=ReferEngineClient,k=Windows.Storage.ApplicationData.current,e=k.roamingSettings,r=k.localSettings,d=!1,g=!1,ft=l.currentApp,nt=l.appActivationArgs,tt=WinJS.Utilities,h=WinJS.UI.Animation,c,it,s=u.ClientFunction,w=u.ServerFunction,p,ut;n.isAvailable=!1;var i=function(){function n(){}return n._styleKey="ReferEngine-Style",Object.defineProperty(n,"style",{get:function(){return r.values[n._styleKey]},set:function(t){r.values[n._styleKey]=t},enumerable:!0,configurable:!0}),n._loadingMessagesKey="ReferEngine-LoadingMessages",Object.defineProperty(n,"loadingMessages",{get:function(){if(n._loadingMessagesCached)return n._loadingMessagesCached;var t=r.values[n._loadingMessagesKey];return n._loadingMessagesCached=JSON.parse(t).value,n._loadingMessagesCached},set:function(t){n._loadingMessagesCached=t;var i=JSON.stringify({value:t});r.values[n._loadingMessagesKey]=i},enumerable:!0,configurable:!0}),n._logoMarkImageDataKey="ReferEngine-LogoMarkImageData",Object.defineProperty(n,"logoMarkImageData",{get:function(){return r.values[n._logoMarkImageDataKey]},set:function(t){r.values[n._logoMarkImageDataKey]=t},enumerable:!0,configurable:!0}),n._logoTextImageDataKey="ReferEngine-LogoTextImageData",Object.defineProperty(n,"logoTextImageData",{get:function(){return r.values[n._logoTextImageDataKey]},set:function(t){r.values[n._logoTextImageDataKey]=t},enumerable:!0,configurable:!0}),n._fbScopeKey="ReferEngine-FacebookScope",Object.defineProperty(n,"fbScope",{get:function(){return r.values[n._fbScopeKey]},set:function(t){r.values[n._fbScopeKey]=t},enumerable:!0,configurable:!0}),n._appIdKey="ReferEngine-AppId",Object.defineProperty(n,"appId",{get:function(){return r.values[n._appIdKey]},set:function(t){r.values[n._appIdKey]=t},enumerable:!0,configurable:!0}),n}(),o=function(){function n(){}return n._timeoutDefault=15e3,n._timeoutKey="ReferEngine-AutoShowTimeout",Object.defineProperty(n,"timeout",{get:function(){var t=e.values[n._timeoutKey];return t?t:(e.values[n._timeoutKey]=n._timeoutDefault,n._timeoutDefault)},set:function(t){e.values[n._timeoutKey]=t},enumerable:!0,configurable:!0}),n._intervalDefault=2,n._intervalKey="ReferEngine-AutoShowInterval",Object.defineProperty(n,"interval",{get:function(){var t=e.values[n._intervalKey];return t?t:(e.values[n._intervalKey]=n._intervalDefault,n._intervalDefault)},set:function(t){e.values[n._intervalKey]=t},enumerable:!0,configurable:!0}),n._enableDefault=!0,n._enableKey="ReferEngine-AutoShowEnable",Object.defineProperty(n,"enable",{get:function(){var t=e.values[n._enableKey];return t?t:(e.values[n._enableKey]=n._enableDefault,n._enableDefault)},set:function(t){e.values[n._enableKey]=t},enumerable:!0,configurable:!0}),n}(),v=function(){function t(){}return t._launchCountKey="ReferEngine-LaunchCount",Object.defineProperty(t,"launchCount",{get:function(){var n=e.values[t._launchCountKey];return n?n:(e.values[t._launchCountKey]=0,0)},set:function(n){e.values[t._launchCountKey]=n},enumerable:!0,configurable:!0}),t._autoAskAgainKey="ReferEngine-AutoAskAgain",Object.defineProperty(t,"autoAskAgain",{get:function(){var n=e.values[t._autoAskAgainKey];return n?n:(e.values[t._autoAskAgainKey]=o.enable,o.enable)},set:function(n){e.values[t._autoAskAgainKey]=n},enumerable:!0,configurable:!0}),t.shouldAutoOpen=function(){return t.launchCount%o.interval==0&&t.autoAskAgain},t.autoOpenIfNeeded=function(){if(nt){var i=nt.detail.previousExecutionState,r=Windows.ApplicationModel.Activation.ApplicationExecutionState;i!==r.running&&i!==r.suspended&&t.launchCount++,t.shouldAutoOpen()&&setTimeout(function(){window.msRequestAnimationFrame(function(){n.show(!0)})},o.timeout)}},t}(),b=function(){function n(){}return n.base="https://www.referengine-test.com",n.auth=n.base+"/recommend/win8/authorizeapp",n.getIntroUrl=function(t){return n.base+"/recommend/win8/intro/"+i.appId+"?isAutoOpen="+(t?"true":"false")},n}(),t=function(){function n(){}return n.createElement=function(n){return document.createElement(n)},n.createDiv=function(t){var i=n.createElement("div");return t!==null&&t!==undefined&&(i.className=t),i},n.createImg=function(t,i){var r=n.createElement("img");return r.src=t,r.className=i,r},n.hideElement=function(n){tt.addClass(n,"re-hidden")},n.unHideElement=function(n){tt.removeClass(n,"re-hidden")},n}(),y=function(){function n(){}return n.hideRing=function(){t.progressSpan.style.visibility="hidden"},n.showRing=function(){t.progressSpan.style.visibility="visible"},n.show=function(){h.enterContent(t.loading).then(function(){t.unHideElement(t.loading)})},n.hide=function(){h.fadeOut(t.loading).then(function(){t.hideElement(t.loading)})},n.setText=function(i){i.substr(0,5)==="Error"&&n.hideRing(),h.exitContent(t.loadingTextElem).done(function(){t.loadingTextElem.innerText=i,h.enterContent(t.loadingTextElem)})},n.loadIntro=function(t){et(),rt(b.getIntroUrl(t)),n.show(),n.showRing();var r=0,u=document.createEvent("CustomEvent");u.initCustomEvent("showNextLoadingMessage",!0,!0,null),document.addEventListener("showNextLoadingMessage",function(){n.setText(i.loadingMessages[r]),r=r===i.loadingMessages.length-1?0:r+1,d||setTimeout(function(){document.dispatchEvent(u)},3e3)}),document.dispatchEvent(u)},n}(),a=function(){function n(){}return n._token="ReferEngine-AuthToken",n._expires="ReferEngine-TokenExpiresAt",n.getStoredToken=function(){function t(){return r.values[n._expires]=null,r.values[n._token]=null,null}var i=r.values[n._expires],u=r.values[n._token];if(!i||!u)return t();var f=new Date,e=f.getTime();return i-600<e?t():u},n.setStoredToken=function(t,i){var u=new Date;u.setSeconds(u.getSeconds()+i),r.values[n._token]=t,r.values[n._expires]=u},n.authorizeFacebookAsync=function(){return new WinJS.Promise(function(n){var t="https://www.referengine.com/recommend/win8/success",u="client_id=368842109866922&redirect_uri="+t+"&scope="+i.fbScope+"&display=popup&response_type=code",e="https://www.facebook.com/dialog/oauth?"+u,o=new Windows.Foundation.Uri(e),s=new Windows.Foundation.Uri(t),r=Windows.Security.Authentication.Web;r.WebAuthenticationBroker.authenticateAsync(r.WebAuthenticationOptions.none,o,s).done(function(t){(t.responseData.indexOf("error_reason=")!==-1||t.responseErrorDetail===404)&&n(new f.AuthResult(!1));var i="code=",u=t.responseData.indexOf(i)+i.length,r=t.responseData.substr(u);r?n(new f.AuthResult(!0,r)):n(new f.AuthResult(!1))},function(){n(new f.AuthResult(!1))})})},n.authorizeAppAsync=function(){return new WinJS.Promise(function(t){var r=n.getStoredToken();r?t(r):ft.getAppReceiptAsync().done(function(r){var u=window.btoa(r);WinJS.xhr({type:"POST",headers:{"Content-type":"text/xml"},url:b.auth,data:r}).done(function(r){var u=JSON.parse(r.responseText);u.token&&u.expiresIn?(n.setStoredToken(u.token,u.expiresIn),o.enable=u.asoEnabled,o.interval=u.asoInterval,o.timeout=u.asoTimeout,i.style=u.style,i.loadingMessages=u.loadingMessages,i.logoMarkImageData=u.logoMarkImageData,i.logoTextImageData=u.logoTextImageData,i.fbScope=u.fbScope,i.appId=u.appId,t(u.token)):t(null)},function(n){console.error("ReferEngine: could not authorize app with ReferEngine.com."),n.statusText&&console.error("ReferEngine - Message from server: "+n.statusText),t(null)})})})},n}();p=!0,n.show=st,n.hide=ht,n.reset=ct,ut=[new u.Function(s.navigate,function(n){rt(n.url)}),new u.Function(s.showLoading,function(){y.show()}),new u.Function(s.hideLoading,function(){y.hide()}),new u.Function(s.setLoadingText,function(n){y.setText(n.text)}),new u.Function(s.setAutoAsk,function(n){v.autoAskAgain=n.askAgain}),new u.Function(s.hide,function(){n.hide()}),new u.Function(s.authFacebook,function(){a.authorizeFacebookAsync().then(function(n){c.call(w.authFacebookResult,{authResult:n})})}),new u.Function(s.setIntroPageLoaded,function(){d=!0,c.call(w.introVisible)})],c=new f.Messenger(f.MessengerType.ClientToIframe,b.base),it=new u.FunctionRange(c),it.addRange(ut),window.ReferEngine=n,lt()})(e||(e={}))})