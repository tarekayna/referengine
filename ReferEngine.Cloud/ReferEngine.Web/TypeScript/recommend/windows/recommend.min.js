define(["require","exports","common"],function(n,t,i){var r=i;n(["/typescript/lib/knockout.js"],function(){$(document).ready(function(){var i=r.ClientMessaging,u=r.MixPanel,y=$("#submit-button"),p=$("#cancel-button"),w=$("#done-button"),n=$("#message"),o=$("#asContainer"),b=$(".post"),l=$(".postResult"),k=$("#agree"),s=$("#re-content .text-message"),f=0,h=0,c="",t="",e,a,v;l.hide(),s.hide(),w.click(function(){i.postAction("done")}),e={enter:13,space:32,up:38,down:40},n.focusin(function(){$(".msg-placeholder").css("display","none")}),a=function(){},v=function(i){var v=function(){var n=this;n.msgText=ko.observable(""),n.msgHTML=ko.observable(""),n.searchString=ko.observable(""),n.friends=JSON.parse(i.friends),n.selectedIndex=ko.observable(-1),n.searchResult=ko.computed(function(){var t=n.searchString().toLowerCase(),u=[],f=[],i;if(t!==undefined&&t!=="")for(i=0;i<n.friends.length;i++){var r=n.friends[i],e=r.FirstName.toLowerCase(),o=r.LastName.toLowerCase();e.indexOf(t)===0&&u.push(r),o.indexOf(t)===0&&f.push(r)}return u.concat(f)}),n.onClick=function(n){l(n)}},r=new v;ko.applyBindings(r),r.searchResult.subscribe(function(t){var i,r;t.length>0?(i=n.find(".search-str"),i.length>0&&(r=i.offset(),r.top+=i.outerHeight(),o.offset(r),i.addClass("highlighted"))):o.css("display","none")});var s=function(){var t=n.find(".search-str");t.length>0&&t.replaceWith(t.text())},l=function(t){n.find(".search-str").replaceWith("<span class='friendTag' data-friend-id='"+t.FacebookId+"'>"+t.Name+"<\/span>"),n.focus(),r.searchString("")},a,u=function(n){return a===n.timeStamp},y=function(){r.searchResult()!==[]&&r.selectedIndex(r.selectedIndex()+1)},p=function(){r.searchResult()!==[]&&r.selectedIndex(r.selectedIndex()-1)};n.focusout(function(){setTimeout(function(){s(),r.searchString("")},500)}),n.keydown(function(t){if(t.which===e.enter){var i=r.selectedIndex();r.searchResult()!==[]&&i!==-1&&(l(r.searchResult()[i]),n.find("p").last().remove()),t.stopImmediatePropagation(),t.preventDefault()}}),n.keyup(function(i){var k,d,o,l;if(i.which===e.up)return p();if(i.which===e.down)return y();if(r.selectedIndex(-1),a=i.timeStamp,s(),r.msgText(n.text()),t="",k=r.msgText(),d=k.length,d===c.length+1)for(o=d-1;o>=0&&u(i);o--)if(k.charAt(o)!==c.charAt(o-1)){if(h=o,t=k.substring(0,o+1),f=t.lastIndexOf(" ")+1,t=t.substring(f),t!==""){var v=n.html(),g=f,nt=h,w=-1,b=!0;if(v.indexOf("<")!==-1)for(l=0;l<v.length;l++)if(b=v.charAt(l)==="<"?!1:b,w=b?w+1:w,b=v.charAt(l)===">"?!0:b,w===f&&(g=l),w===h){nt=l;break}var tt=v.substring(0,g),it=v.substring(nt+1),rt=tt+"<span class='search-str'>"+t+"<\/span>"+it;u(i)&&r.msgHTML(rt)}break}u(i)&&(r.searchString(t),c=r.msgText(),r.msgHTML(n.html()))})},$.ajax(r.Url.getFriends,{type:"POST",data:{re_auth_token:ReferEngineGlobals.referEngineAuthToken},dataType:"json",error:a,success:v});var d=function(){i.showLoading("Error posting to Facebook. Please try again."),u.track("Recommend Post Error",null)},g=function(){b.hide(),l.show(),i.hideLoading(),u.track("Recommend Post Success",null)},nt=function(){s.show({complete:function(){setTimeout(function(){s.hide({duration:1e3})},2e3)}})};y.click(function(){var f,t,e;k[0].checked?(i.showLoading("Posting to Facebook..."),f=n.clone(),t=f.find(".friendTag"),t.length>0&&t.replaceWith(function(){var n=$(this).attr("data-friend-id");$(this).replaceWith("@["+n+"]")}),e=f.text(),$.ajax({type:"POST",url:r.Url.postRecommendation,data:{message:e,re_auth_token:ReferEngineGlobals.referEngineAuthToken},dataType:"json",error:d,success:g}),u.track("Recommend Post Submit",{"Includes Message":e!=="","Includes Tags":t.length>0})):nt()}),p.click(function(){i.postAction("cancel"),u.track("Recommend Post Cancel",null)}),o.css("display","none"),i.hideLoading(),u.track("Recommend Post",null)})})})